#!/usr/bin/env python3

# panel A

import glob
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
import numpy as np
from shapely.geometry import Point
from tqdm import tqdm

import matplotlib as mpl
mpl.rc('font',family='Arial')

csv_files = glob.glob("/Volumes/easystore/hourly_precip/cleaned_hourly/*.csv")

# define season mapping
def get_season(month):
    if month in [12, 1, 2]:
        return "DJF"
    elif month in [3, 4, 5]:
        return "MAM"
    elif month in [6, 7, 8]:
        return "JJA"
    else:
        return "SON"

season_results = []

for file_path in tqdm(csv_files):
    df = pd.read_csv(file_path)
    df["DATE"] = pd.to_datetime(df["DATE"])
    df["year"] = df["DATE"].dt.year
    df["month"] = df["DATE"].dt.month
    df["season"] = df["month"].apply(get_season)

    seasonal_counts = {"DJF": 0, "MAM": 0, "JJA": 0, "SON": 0}
    for year in df["year"].unique():
        year_df = df[df["year"] == year]
        max_row = year_df.loc[year_df["precip"].idxmax()]
        seasonal_counts[max_row["season"]] += 1

    dominant_season = max(seasonal_counts, key=seasonal_counts.get)
    
    season_results.append({
        "NAME": df["NAME"].iloc[0],
        "LATITUDE": df["LATITUDE"].iloc[0],
        "LONGITUDE": df["LONGITUDE"].iloc[0],
        "season": dominant_season
    })
    
# convert to gdf
results_df = pd.DataFrame(season_results)
geometry = [Point(xy) for xy in zip(results_df["LONGITUDE"], results_df["LATITUDE"])]
gdf = gpd.GeoDataFrame(results_df, geometry=geometry, crs="EPSG:4326")

# import US states shapefile and subset to WUS
states = gpd.read_file('cb_2018_us_state_5m.shp')
states = states.to_crs("EPSG:4326")
states = states[states.NAME.isin([
    'Washington','Oregon','Idaho','Montana','California','Nevada',
    'Utah','Wyoming','Colorado','Arizona','New Mexico'])]

# percentages for legend
num_djf = (len(gdf[gdf["season"] == "DJF"])/140) * 100
num_mam = (len(gdf[gdf["season"] == "MAM"])/140) * 100
num_jja = (len(gdf[gdf["season"] == "JJA"])/140) * 100
num_son = (len(gdf[gdf["season"] == "SON"])/140) * 100
season_numbers = [num_djf,num_mam,num_jja,num_son]

# plotting

fig, ax = plt.subplots(figsize=(10, 8))
states.boundary.plot(ax=ax, edgecolor='k')

season_colors = {"DJF": "blue", "MAM": "c", "JJA": "red", "SON": "orange"}

# Plot season-specific points
for i, (season, color) in enumerate(season_colors.items()):
    subset = gdf[gdf["season"] == season]
    if not subset.empty:
        subset.plot(ax=ax, color=color, markersize=100, edgecolor="black", label=f'{season} ({season_numbers[i]:.1f}%)')
# # Annotate each point with its station name
# for x, y, label in zip(gdf.geometry.x, gdf.geometry.y, gdf['NAME']):
#     ax.annotate(label, xy=(x, y), xytext=(3, 3), textcoords="offset points", fontsize=8)

# create a custom legend 
handles, labels = ax.get_legend_handles_labels()
if handles:
    plt.legend(handles, labels, loc="lower left", bbox_to_anchor=(-0.05, 0.08), fontsize=10)

ax.set_title("Most common season of 1-hr AMP", fontsize=20, y=0.96)
ax.set_axis_off()

# panel B

# time of day for peak annual 1-hour precipitation

import glob
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
import numpy as np
from shapely.geometry import Point
from tqdm import tqdm

# List all the CSV files
csv_files = glob.glob("/Volumes/easystore/hourly_precip/cleaned_hourly/*.csv")

# Define hour bin mapping
def get_hour_bin(hour):
    if 0 <= hour <= 5:
        return "00:00-05:00"
    elif 6 <= hour <= 11:
        return "06:00-11:00"
    elif 12 <= hour <= 17:
        return "12:00-17:00"
    elif 18 <= hour <= 23:
        return "18:00-23:00"

# Store results
time_results = []

for file_path in tqdm(csv_files):
    df = pd.read_csv(file_path)
    df["DATE"] = pd.to_datetime(df["DATE"])
    df["year"] = df["DATE"].dt.year
    df["hour"] = df["DATE"].dt.hour
    df["hour_bin"] = df["hour"].apply(get_hour_bin)

    hourly_counts = {"00:00-05:00": 0, "06:00-11:00": 0, "12:00-17:00": 0, "18:00-23:00": 0}
    for year in df["year"].unique():
        year_df = df[df["year"] == year]
        if year_df.precip.max() > 0: # filter our if year/season max is zero
            max_row = year_df.loc[year_df["precip"].idxmax()]
            hourly_counts[max_row["hour_bin"]] += 1

    total_years = sum(hourly_counts.values())
    dominant_bin = max(hourly_counts, key=hourly_counts.get)
    dominant_count = hourly_counts[dominant_bin]
    
    assigned_bin = dominant_bin
    # if dominant_count / total_years >= 0.5:
    #     assigned_bin = dominant_bin
    # else:
    #     assigned_bin = "Other"  # Mark gray for ambiguous dominant bins

    time_results.append({
        "NAME": df["NAME"].iloc[0],
        "LATITUDE": df["LATITUDE"].iloc[0],
        "LONGITUDE": df["LONGITUDE"].iloc[0],
        "time_bin": assigned_bin
    })

# Convert to GeoDataFrame
results_df = pd.DataFrame(time_results)
geometry = [Point(xy) for xy in zip(results_df["LONGITUDE"], results_df["LATITUDE"])]
gdf = gpd.GeoDataFrame(results_df, geometry=geometry, crs="EPSG:4326")

# Import US states shapefile and subset to western US
states = gpd.read_file('cb_2018_us_state_5m.shp')
states = states.to_crs("EPSG:4326")
states = states[states.NAME.isin([
    'Washington','Oregon','Idaho','Montana','California','Nevada',
    'Utah','Wyoming','Colorado','Arizona','New Mexico'])]

# Define color map
time_colors = {
    "00:00-05:00": "k",
    "06:00-11:00": "#D2B48C",
    "12:00-17:00": "tab:purple",
    "18:00-23:00": "cornflowerblue",
    "Other": "gray"
}

num_1 = (len(gdf[gdf["time_bin"] == "00:00-05:00"])/140) * 100
num_2 = (len(gdf[gdf["time_bin"] == "06:00-11:00"])/140) * 100
num_3 = (len(gdf[gdf["time_bin"] == "12:00-17:00"])/140) * 100
num_4 = (len(gdf[gdf["time_bin"] == "18:00-23:00"])/140) * 100
time_numbers = [num_1,num_2,num_3,num_4]

# Plot
fig, ax = plt.subplots(figsize=(10, 8))
states.boundary.plot(ax=ax, edgecolor='k')

# Plot season-specific points
for i, (time_bin, color) in enumerate(time_colors.items()):
    subset = gdf[gdf["time_bin"] == time_bin]
    if not subset.empty:
        subset.plot(ax=ax, color=color, markersize=100, edgecolor="black", label=f'{time_bin} ({time_numbers[i]:.1f}%)')

# # Plot 'Other' stations separately (gray color, no label in legend)
# gdf[gdf["time_bin"] == "Other"].plot(ax=ax, color="gray", markersize=100)

# Add legend (only for the bins that actually have data)
handles, labels = ax.get_legend_handles_labels()
if handles:
    plt.legend(handles, labels, loc="lower left", bbox_to_anchor=(-0.1, 0.08), fontsize=10)

#ax.set_title("Most common time of day for annual max 1-hr precipitation", fontsize=16, y=0.97)
ax.set_axis_off()
plt.show()

    

plt.title("Median 1-hr AMP amounts", fontsize=20, y=0.96)
ax.set_axis_off()
plt.show()
